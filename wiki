#!/bin/sh

readonly VERSION="25.08"

readonly EXIT_SUCCESS=0
readonly EXIT_FAILURE=1

readonly ENV_OPTS="WIKI_PATH \
									 WIKI_INBOX \
									 WIKI_DAILY_PATH \
									 WIKI_TEMPLATE_PATH \
									 WIKI_PAGER_CMD \
									 WIKI_PAGER_OPTS \
									 WIKI_PREVIEW_CMD \
									 WIKI_PREVIEW_OPTS \
									 WIKI_FILEMGR_CMD \
									 WIKI_FILEMGR_OPTS \
									 WIKI_GREP_OPTS"

OPT_WIKI_PATH="${WIKI_PATH:-}"

OPT_WIKI_INBOX="${WIKI_INBOX:-}"
OPT_WIKI_DAILY_PATH="${WIKI_DAILY_PATH:-}"
OPT_WIKI_DAILY=""
OPT_WIKI_TEMPLATE_PATH="${WIKI_TEMPLATE_PATH:-}"
OPT_WIKI_NEW_NAME=""

OPT_WIKI_PRINT_FNAME=""
OPT_WIKI_OPEN=""

OPT_WIKI_PAGER_CMD="${WIKI_PAGER_CMD:-less}"
OPT_WIKI_PAGER_OPTS="${WIKI_PAGER_OPTS:-}"

OPT_WIKI_PREVIEW_CMD="${WIKI_PREVIEW_CMD:-cat}"
OPT_WIKI_PREVIEW_OPTS="${WIKI_PREVIEW_OPTS:-}"

OPT_WIKI_FILEMGR_CMD="${WIKI_FILEMGR_CMD:-tree}"
OPT_WIKI_FILEMGR_OPTS="${WIKI_FILEMGR_OPTS:-}"

OPT_WIKI_GREP_QUERY=""
OPT_WIKI_GREP_OPTS="${WIKI_GREP_OPTS:--i}"

print_version() {
	echo >&2 "wiki ${VERSION}"
}

print_usage() {
	cat >&2 <<EOF
USAGE: $(basename "${PROG}") [OPTIONS..] [FILENAME]

OPTIONS:
  General:
    --help, -h               Print usage
    --version, -V            Print the version
    --completions SHELL      Generate shell completions

  File/Directory:
    --path PATH              Specify PATH to wiki directory
    --new, -n NAME           Create a new entry
    --inbox, -I PATH         Specify PATH where new entries are created
    --print, -f              Print the selected filename and exit
    --open, -o               Open the wiki directory
    --daily, -d              Open a daily note
    --daily-path PATH        Specify PATH for daily notes

  Search:
    --grep, -g QUERY         Search files for QUERY
    --grep-opts OPTS         Pass in options to grep

  External Tools:
    --pager, -p PAGER        Open files with PAGER
    --pager-opts OPTS        Pass in options to the pager command
    --filemgr, -F FILEMGR    Open wiki directory with FILEMGR
    --filemgr-opts OPTS      Pass in options to the file manager command
    --preview, -P PREVIEW    Preview files with PREVIEW
    --preview-opts OPTS      Pass in options to the preview command

EXAMPLES:
  wiki -g "my search query"
  wiki -n "new note title"
  wiki --path /path/to/another/wiki

ENVIRONMENT:
EOF

	for var in $ENV_OPTS; do
		printf '  %-18s = "%s"\n' "$var" "$(eval echo "\${OPT_$var:-}")"
	done
}

print_completions() {
	case "$1" in
		bash)
			cat <<'EOF'
_wiki_completions() {
    COMPREPLY=($(compgen -W "--help --version --path --new --inbox --print --open --daily --daily-path --grep --grep-opts --pager --pager-opts --filemgr --filemgr-opts --preview --preview-opts" -- "${COMP_WORDS[1]}"))
}
complete -F _wiki_completions wiki
EOF
			;;
		zsh)
			cat <<'EOF'
#compdef wiki
_wiki() {
    _arguments \
        '--help[Print usage]' \
        '--version[Print the version]' \
        '--path[Specify PATH to wiki directory]:PATH:_path_files -/' \
        '--new[Create a new entry]:NAME' \
        '--inbox[Specify PATH where new entries are created]:PATH:_path_files -/' \
        '--print[Print the selected filename and exit]' \
        '--open[Open the wiki directory]' \
        '--daily[Open a daily note]' \
        '--daily-path[Specify PATH for daily notes]:PATH:_path_files -/' \
        '--grep[Search files for QUERY]:QUERY' \
        '--grep-opts[Pass in options to grep]:OPTS' \
        '--pager[Open files with PAGER]:PAGER' \
        '--pager-opts[Pass in options to the pager command]:OPTS' \
        '--filemgr[Open wiki directory with FILEMGR]:FILEMGR' \
        '--filemgr-opts[Pass in options to the file manager command]:OPTS' \
        '--preview[Preview files with PREVIEW]:PREVIEW' \
        '--preview-opts[Pass in options to the preview command]:OPTS'
}
_wiki "$@"
EOF
			;;
		fish)
			cat <<'EOF'
complete -c wiki -s h -l help -d "Print usage"
complete -c wiki -s V -l version -d "Print the version"
complete -c wiki -l path -d "Specify PATH to wiki directory" -r
complete -c wiki -s n -l new -d "Create a new entry"
complete -c wiki -s I -l inbox -d "Specify PATH where new entries are created" -r
complete -c wiki -s f -l print -d "Print the selected filename and exit"
complete -c wiki -s o -l open -d "Open the wiki directory"
complete -c wiki -s d -l daily -d "Open a daily note"
complete -c wiki -l daily-path -d "Specify PATH for daily notes" -r
complete -c wiki -s g -l grep -d "Search files for QUERY"
complete -c wiki -l grep-opts -d "Pass in options to grep"
complete -c wiki -s p -l pager -d "Open files with PAGER"
complete -c wiki -l pager-opts -d "Pass in options to the pager command"
complete -c wiki -s F -l filemgr -d "Open wiki directory with FILEMGR"
complete -c wiki -l filemgr-opts -d "Pass in options to the file manager command"
complete -c wiki -s P -l preview -d "Preview files with PREVIEW"
complete -c wiki -l preview-opts -d "Pass in options to the preview command"
EOF
			;;
	esac
}

parse() {
	while [ "$#" -gt 0 ]; do
		case "${1}" in
			--help|-h)
				print_usage
				exit $EXIT_SUCCESS
				;;
			--version|-V)
				print_version
				exit $EXIT_SUCCESS
				;;
			--completions)
				if [ -z "$2" ]; then
					echo >&2 "ERROR: --completions requires a shell argument (e.g., bash, zsh, fish)"
					exit $EXIT_FAILURE
				fi
				print_completions "$2"
				exit $EXIT_SUCCESS
				;;
			--path)
				OPT_WIKI_PATH="$2"
				shift 2
				;;
			--new|-n)
				OPT_WIKI_NEW_NAME="${2}"
				shift 2
				;;
			--inbox|-I)
				OPT_WIKI_INBOX="$2"
				shift 2
				;;
			--daily|-d)
				OPT_WIKI_DAILY=1
				shift
				;;
			--daily-path)
				OPT_WIKI_DAILY_PATH="$2"
				shift 2
				;;
			--print|-f)
				OPT_WIKI_PRINT_FNAME=1
				shift
				;;
			--open|-o)
				OPT_WIKI_OPEN=1
				shift
				;;
			--pager|-p)
				OPT_WIKI_PAGER_CMD="$2"
				shift 2
				;;
			--pager-opts)
				OPT_WIKI_PAGER_OPTS="$2"
				shift 2
				;;
			--preview|-P)
				OPT_WIKI_PREVIEW_CMD="$2"
				shift 2
				;;
			--preview-opts)
				OPT_WIKI_PREVIEW_OPTS="$2"
				shift 2
				;;
			--filemgr|-F)
				OPT_WIKI_FILEMGR_CMD="$2"
				shift 2
				;;
			--filemgr-opts)
				OPT_WIKI_FILEMGR_OPTS="$2"
				shift 2
				;;
			--grep|-g)
				OPT_WIKI_GREP_QUERY="$2"
				shift 2
				;;
			--grep-opts)
				OPT_WIKI_GREP_OPTS="$2"
				shift 2
				;;
			*)
				OPT_QUERY="${*}"
				break
				;;
		esac
	done
}

check_sanity() {
	# Ensure wiki path is set and exists
	[ -n "${OPT_WIKI_PATH}" ] || {
		echo >&2 "Please set WIKI_PATH or use --path"
		return $EXIT_FAILURE
	}

	[ -d "${OPT_WIKI_PATH}" ] || {
		echo >&2 "${OPT_WIKI_PATH} does not exist"
	}

	# Ensure fzf exists
	command -v fzf >/dev/null 2>&1 || {
		echo >&2 "Could not find 'fzf' in your PATH"
		return $EXIT_FAILURE
	}

	# Ensure pager is set and exists
	[ -n "${OPT_WIKI_PAGER_CMD}" ] || {
		echo >&2 "Please set WIKI_PAGER_CMD or use --pager"
		return $EXIT_FAILURE
	}

	command -v "${OPT_WIKI_PAGER_CMD}" >/dev/null 2>&1 || {
		echo >&2 "Pager command '${OPT_WIKI_PAGER_CMD}' could not be found"
		return $EXIT_FAILURE
	}

	# Ensure preview command is set and exists
	[ -n "${OPT_WIKI_PREVIEW_CMD}" ] || {
		echo >&2 "Please set WIKI_PREVIEW_CMD or use --preview"
		return $EXIT_FAILURE
	}

	command -v "${OPT_WIKI_PREVIEW_CMD}" >/dev/null 2>&1 || {
		echo >&2 "Preview command '${OPT_WIKI_PREVIEW_CMD}' could not be found"
		return $EXIT_FAILURE
	}

	# Ensure file manager is set and exists
	[ -n "${OPT_WIKI_FILEMGR_CMD}" ] || {
		echo >&2 "Please set WIKI_FILEMGR_CMD or use --filemgr"
		return $EXIT_FAILURE
	}

	command -v "${OPT_WIKI_FILEMGR_CMD}" >/dev/null 2>&1 || {
		echo >&2 "File manager command '${OPT_WIKI_FILEMGR_CMD}' could not be found"
		return $EXIT_FAILURE
	}
}

find_files() (
	IFS=":"

	[ -z "${OPT_WIKI_GREP_QUERY}" ] || {
		# shellcheck disable=SC2086
		find "${OPT_WIKI_PATH}" -type f -print0 |
			sed -z '/\/\./d' |
			xargs -0 grep -l ${OPT_WIKI_GREP_OPTS} "${OPT_WIKI_GREP_QUERY}" |
			sed "s|${OPT_WIKI_PATH}/||"

	  return $EXIT_SUCCESS
	}

	find "${OPT_WIKI_PATH}" -type f ! -path '**/.*' -prune -printf '%P\n'
)

run() {
	find_files | fzf \
		--ansi \
		--select-1 \
		--preview="${OPT_WIKI_PREVIEW_CMD} ${OPT_WIKI_PREVIEW_OPTS} ${OPT_WIKI_PATH}/{}" \
		--query="${OPT_QUERY:-}"
}

main() {
	set -eu
	readonly PROG="${0}"

	parse "$@"
	check_sanity

	[ -z "$OPT_WIKI_OPEN" ] || {
		"${OPT_WIKI_FILEMGR_CMD}" \
			"${OPT_WIKI_FILEMGR_OPTS}" \
			"${OPT_WIKI_PATH}"

		return $EXIT_SUCCESS
	}

	if [ -n "$OPT_WIKI_DAILY" ]; then
		# Format: <year>/<month>/<date>-<weekday>.md
		# Example: 2025/12/05-Friday.md
		year="$(date +%Y)"
		month="$(date +%m)"
		date_weekday="$(date +%d-%A)"
		
		# Construct the full filename including the directory structure
		fname="${year}/${month}/${date_weekday}.md"

		wiki_root="$(echo "${OPT_WIKI_PATH}" | cut -d: -f1)"

		case "${OPT_WIKI_DAILY_PATH}" in
			/*) daily_path="${OPT_WIKI_DAILY_PATH}" ;;
			*) daily_path="${wiki_root}/${OPT_WIKI_DAILY_PATH}" ;;
		esac

		# Create the full directory path if it doesn't exist
		[ -d "${daily_path}/${year}/${month}" ] || mkdir -p "${daily_path}/${year}/${month}"
		
		cd "${daily_path}/${year}/${month}"

		# shellcheck disable=SC2086
		"${OPT_WIKI_PAGER_CMD}" ${OPT_WIKI_PAGER_OPTS} "${date_weekday}.md"
		return $EXIT_SUCCESS
	fi

	if [ -n "$OPT_WIKI_NEW_NAME" ]; then
		case "${OPT_WIKI_INBOX}" in
			/*) inbox_path="${OPT_WIKI_INBOX}" ;;
			*) inbox_path="${OPT_WIKI_PATH}/${OPT_WIKI_INBOX}" ;;
		esac

		fname="${inbox_path}/${OPT_WIKI_NEW_NAME}.md"

		if [ -n "$OPT_WIKI_TEMPLATE_PATH" ] && [ -f "$OPT_WIKI_TEMPLATE_PATH" ]; then
			cp "$OPT_WIKI_TEMPLATE_PATH" "$fname"
		else
			true > "$fname"
		fi
	else
		fname="$(run)"
	fi

	[ -n "${fname}" ] ||
		return $EXIT_SUCCESS

	[ -z "${OPT_WIKI_PRINT_FNAME}" ] || {
		echo "${OPT_WIKI_PATH}/${fname}"
		return $EXIT_SUCCESS
	}

	cd "${OPT_WIKI_PATH}"

	# shellcheck disable=SC2086
	"${OPT_WIKI_PAGER_CMD}" ${OPT_WIKI_PAGER_OPTS} "${fname}"
}

main "$@"
